require "racer"
require "tempfile"
require "/home/richard/repos/gems/racer-rb/test/test_collector"

out_file = Tempfile.new
agent_pid = Racer.start_agent(collectors: [TestCollector.new(out: out_file.path)])

at_exit do
  Racer.flush
  Racer.stop_agent(agent_pid)

  expected = out_file.read
  out_file.close

  unless defined?(DATA)
    if false
      File.write("test/test_cases/param_types.rb", "__END__\n#{expected}", mode: "a")
      $stderr.puts("Wrote expected result because A=write was passed")
    else
      $stderr.puts "Undefined expectation. Please use A=write rake test to generate the expected trace"
    end
    exit
  end

  actual = DATA.read.chomp!

  if actual != expected
    if false
      file = File.open("test/test_cases/param_types.rb", "r+")
      file.each do |line|
        if line == "__END__\n"
          break
        end
      end

      file.write(expected)
      file.truncate(file.pos)
      file.close
      $stderr.puts("Updated expected result because A=write was passed")
    else
      require "difftastic"
      differ =
        ::Difftastic::Differ.new(
          color: :always,
          tab_width: 2,
          syntax_highlight: :off,
          left_label: "Expected",
          right_label: "to be equal"
        )

      $stderr.puts differ.diff_yaml(actual, expected)
    end
  end
end

def foo(required_pos, optional_pos = 1, *args, required_kw:, optional_kw: 1, **other_kwargs, &block)
end

def bar(a, *rest, b)
end

def anon(*, **, &)
end

def baz(...)
end

def nilkey(a, **nil)
end

def arr_params((key, bar))
end

Racer.start

foo(3, nil, "args", "more args", required_kw: 4, optional_kw: :bar, foo: :baz, "test-symbol": /regex/) do
  1 + 2
end

bar(1, 2, 3, 4, 5, "6")

anon(1, 2, foo: :bar) do
end

baz(1, 2, foo: :bar) do
  3 + 4
end

nilkey(3)

# RACER-TODO: This reports as 0 arguments
# arr_params([2, 3])

Racer.stop

__END__
---
- !ruby/object:Racer::Trace
  method_owner: !ruby/object:Racer::Trace::Constant
    name: Object
    type: :class
    path: []
  method_name: foo
  method_kind: :instance
  return_type: !ruby/object:Racer::Trace::Constant
    name: NilClass
    type: :class
    path: []
  params:
  - !ruby/object:Racer::Trace::Param
    name: :required_pos
    type_name: !ruby/object:Racer::Trace::Constant
      name: Integer
      type: :class
      path: []
    type: :required
  - !ruby/object:Racer::Trace::Param
    name: :optional_pos
    type_name: !ruby/object:Racer::Trace::Constant
      name: NilClass
      type: :class
      path: []
    type: :optional
  - !ruby/object:Racer::Trace::Param
    name: :args
    type_name: !ruby/object:Racer::Trace::Constant
      name: Array
      type: :class
      path: []
    type: :rest
  - !ruby/object:Racer::Trace::Param
    name: :required_kw
    type_name: !ruby/object:Racer::Trace::Constant
      name: Integer
      type: :class
      path: []
    type: :keyword_required
  - !ruby/object:Racer::Trace::Param
    name: :optional_kw
    type_name: !ruby/object:Racer::Trace::Constant
      name: Symbol
      type: :class
      path: []
    type: :keyword_optional
  - !ruby/object:Racer::Trace::Param
    name: :other_kwargs
    type_name: !ruby/object:Racer::Trace::Constant
      name: Hash
      type: :class
      path: []
    type: :keyword_rest
  - !ruby/object:Racer::Trace::Param
    name: :block
    type_name: !ruby/object:Racer::Trace::Constant
      name: Proc
      type: :class
      path: []
    type: :block
- !ruby/object:Racer::Trace
  method_owner: !ruby/object:Racer::Trace::Constant
    name: Object
    type: :class
    path: []
  method_name: bar
  method_kind: :instance
  return_type: !ruby/object:Racer::Trace::Constant
    name: NilClass
    type: :class
    path: []
  params:
  - !ruby/object:Racer::Trace::Param
    name: :a
    type_name: !ruby/object:Racer::Trace::Constant
      name: Integer
      type: :class
      path: []
    type: :required
  - !ruby/object:Racer::Trace::Param
    name: :rest
    type_name: !ruby/object:Racer::Trace::Constant
      name: Array
      type: :class
      path: []
    type: :rest
  - !ruby/object:Racer::Trace::Param
    name: :b
    type_name: !ruby/object:Racer::Trace::Constant
      name: String
      type: :class
      path: []
    type: :required
- !ruby/object:Racer::Trace
  method_owner: !ruby/object:Racer::Trace::Constant
    name: Object
    type: :class
    path: []
  method_name: anon
  method_kind: :instance
  return_type: !ruby/object:Racer::Trace::Constant
    name: NilClass
    type: :class
    path: []
  params:
  - !ruby/object:Racer::Trace::Param
    name: :*
    type_name: !ruby/object:Racer::Trace::Constant
      name: Array
      type: :class
      path: []
    type: :rest
  - !ruby/object:Racer::Trace::Param
    name: :**
    type_name: !ruby/object:Racer::Trace::Constant
      name: Hash
      type: :class
      path: []
    type: :keyword_rest
  - !ruby/object:Racer::Trace::Param
    name: :&
    type_name: !ruby/object:Racer::Trace::Constant
      name: Proc
      type: :class
      path: []
    type: :block
- !ruby/object:Racer::Trace
  method_owner: !ruby/object:Racer::Trace::Constant
    name: Object
    type: :class
    path: []
  method_name: baz
  method_kind: :instance
  return_type: !ruby/object:Racer::Trace::Constant
    name: NilClass
    type: :class
    path: []
  params:
  - !ruby/object:Racer::Trace::Param
    name: :*
    type_name: !ruby/object:Racer::Trace::Constant
      name: Array
      type: :class
      path: []
    type: :rest
  - !ruby/object:Racer::Trace::Param
    name: :**
    type_name: !ruby/object:Racer::Trace::Constant
      name: Hash
      type: :class
      path: []
    type: :keyword_rest
  - !ruby/object:Racer::Trace::Param
    name: :&
    type_name: !ruby/object:Racer::Trace::Constant
      name: Proc
      type: :class
      path: []
    type: :block
- !ruby/object:Racer::Trace
  method_owner: !ruby/object:Racer::Trace::Constant
    name: Object
    type: :class
    path: []
  method_name: nilkey
  method_kind: :instance
  return_type: !ruby/object:Racer::Trace::Constant
    name: NilClass
    type: :class
    path: []
  params:
  - !ruby/object:Racer::Trace::Param
    name: :a
    type_name: !ruby/object:Racer::Trace::Constant
      name: Integer
      type: :class
      path: []
    type: :required

