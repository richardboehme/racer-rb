require "racer"
require "tempfile"
require "/home/richard/repos/gems/racer-rb/test/test_collector"

out_file = Tempfile.new
agent_pid = Racer.start_agent(collectors: [TestCollector.new(out: out_file.path)])

at_exit do
  Racer.flush
  Racer.stop_agent(agent_pid)

  expected = out_file.read
  out_file.close

  unless defined?(DATA)
    if true
      File.write("test/test_cases/nested_constants.rb", "__END__\n#{expected}", mode: "a")
      $stderr.puts("Wrote expected result because A=write was passed")
    else
      $stderr.puts "Undefined expectation. Please use A=write rake test to generate the expected trace"
    end
    exit
  end

  actual = DATA.read.chomp!

  if actual != expected
    if true
      file = File.open("test/test_cases/nested_constants.rb", "r+")
      file.each do |line|
        if line == "__END__\n"
          break
        end
      end

      file.write(expected)
      file.truncate(file.pos)
      file.close
      $stderr.puts("Updated expected result because A=write was passed")
    else
      require "difftastic"
      differ =
        ::Difftastic::Differ.new(
          color: :always,
          tab_width: 2,
          syntax_highlight: :off,
          left_label: "Expected",
          right_label: "to be equal"
        )

      $stderr.puts differ.diff_yaml(actual, expected)
    end
  end
end

module A
  class B
    class C
      def foo(a)
        a
      end
    end
  end
end

Racer.start
A::B::C.new.foo(A::B::C.new)
Racer.stop

__END__
---
- !ruby/object:Racer::Trace
  method_owner: !ruby/object:Racer::Trace::Constant
    name: A::B::C
    type: :class
    path:
    - !ruby/object:Racer::Trace::Constant::PathFragment
      name: :A
      type: :module
    - !ruby/object:Racer::Trace::Constant::PathFragment
      name: :B
      type: :class
  method_name: foo
  method_kind: :instance
  return_type: !ruby/object:Racer::Trace::Constant
    name: A::B::C
    type: :class
    path:
    - !ruby/object:Racer::Trace::Constant::PathFragment
      name: :A
      type: :module
    - !ruby/object:Racer::Trace::Constant::PathFragment
      name: :B
      type: :class
  params:
  - !ruby/object:Racer::Trace::Param
    name: :a
    type_name: !ruby/object:Racer::Trace::Constant
      name: A::B::C
      type: :class
      path:
      - !ruby/object:Racer::Trace::Constant::PathFragment
        name: :A
        type: :module
      - !ruby/object:Racer::Trace::Constant::PathFragment
        name: :B
        type: :class
    type: :required

