require "racer"
require "tempfile"
require "/home/richard/repos/gems/racer-rb/test/test_collector"

out_file = Tempfile.new
agent_pid = Racer.start_agent(collectors: [TestCollector.new(out: out_file.path)])

at_exit do
  Racer.flush
  Racer.stop_agent(agent_pid)

  expected = out_file.read
  out_file.close

  unless defined?(DATA)
    if false
      File.write("test/test_cases/retry.rb", "__END__\n#{expected}", mode: "a")
    else
      $stderr.puts "Undefined expectation. Please use A=write rake test to generate the expected trace"
    end
    exit
  end

  actual = DATA.read.chomp!

  if actual != expected
    if false
      file = File.open("test/test_cases/retry.rb", "r+")
      file.each do |line|
        if line == "__END__\n"
          break
        end
      end

      file.write(expected)
      file.truncate(file.pos)
      file.close
      $stderr.puts("written changes")
    else
      require "difftastic"
      differ =
        ::Difftastic::Differ.new(
          color: :always,
          tab_width: 2,
          syntax_highlight: :off,
          left_label: "Expected",
          right_label: "to be equal"
        )

      $stderr.puts differ.diff_objects(actual, expected)
    end
  end
end

$counter = 0
def foo
  if $counter == 0
    $counter += 1
    raise
  end
rescue
  retry
end

Racer.start
foo
Racer.stop

__END__
---
- !ruby/object:Racer::Trace
  method_owner: !ruby/object:Racer::Trace::Constant
    name: Object
    type: :class
    path: []
  method_name: foo
  method_kind: :instance
  return_type: !ruby/object:Racer::Trace::Constant
    name: NilClass
    type: :class
    path: []
  params: []

